steps:
- script: |
    pwd
    mkdir -p '$(Pipeline.Workspace)/build-workspace'
  displayName: 'create workspace'

- task: DownloadPipelineArtifact@2
  inputs:
    buildType: 'specific'
    project: 'f6ab42a1-9699-4b5f-a01c-747fb9656456'
    definition: '4'
    buildVersionToDownload: 'latest'
    artifactName: 'metadata'
    targetPath: '$(Pipeline.Workspace)/build-workspace/devops'
  displayName: 'Download devops metadata artifacts'

- task: DownloadPipelineArtifact@2
  inputs:
    buildType: 'specific'
    project: 'f6ab42a1-9699-4b5f-a01c-747fb9656456'
    definition: '5'
    buildVersionToDownload: 'latest'
    targetPath: '$(Pipeline.Workspace)/build-workspace/backend'
  displayName: 'Download backend artifacts'

- task: DownloadPipelineArtifact@2
  inputs:
    buildType: 'specific'
    project: 'f6ab42a1-9699-4b5f-a01c-747fb9656456'
    definition: '7'
    buildVersionToDownload: 'latest'
    targetPath: '$(Pipeline.Workspace)/build-workspace/components'
  displayName: 'Download components artifacts'

- task: DownloadPipelineArtifact@2
  inputs:
    buildType: 'specific'
    project: 'f6ab42a1-9699-4b5f-a01c-747fb9656456'
    definition: '1'
    buildVersionToDownload: 'latest'
    targetPath: '$(Pipeline.Workspace)/build-workspace/webclient'
  displayName: 'Download webclient artifacts'

- script: |
    cp $(Pipeline.Workspace)/build-workspace/devops/metadata/Dockerfile $(Pipeline.Workspace)/build-workspace/Dockerfile
  displayName: 'Copy Dockerfile to build workspace'

- task: Docker@2
  inputs:
    containerRegistry: 'NoamaDockerHub'
    repository: 'noamasela/k8s-bootstrapper'
    command: 'buildAndPush'
    Dockerfile: '$(Pipeline.Workspace)/build-workspace/Dockerfile'
    tags: |
      $(Build.BuildId)
      $(Build.SourceVersion)
      latest
  displayName: 'Docker build and push'
